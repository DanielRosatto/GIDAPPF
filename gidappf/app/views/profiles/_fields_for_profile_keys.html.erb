<% unless profile.errors.any? then %>
  <%= form.fields_for :profile_keys, profile.profile_keys.order(:id,:attrib_id) do |nested| %>
    <%= nested.hidden_field :key, :value => profile.profile_keys.order(:id,:attrib_id)[nested.index].key %>
    <%= nested.fields_for :profile_values, profile.profile_keys.order(:id,:attrib_id)[nested.index].profile_values.order(:id) do |nested2| %>
        <%= render "fields_for_profile_values", form: nested2, profile_id: profile.id, nested_index: nested.index %>
      <% end %>
  <% end %>
<% end %>
